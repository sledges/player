#NAMESPACE=stream

dependencies::depends $OUTPUT_INTERFACE

NAMESPACED icecast_pid=-1
NAMESPACED ezstream_pid=-1

function start() {
    start_icecast
    start_ezstream
    start_watchdog&
}

function refresh_metadata() {
    kill -12 ${NAMESPACED ezstream_pid}
}

function start_ezstream() {
    logger::log "info" "starting ezstream"
    output::start | ezstream -c /tmp/ezstream.xml&
    NAMESPACED ezstream_pid=$!
    logger::log "info" "ezstream pid ${NAMESPACED ezstream_pid}"
    sleep 3 #TODO: fixme
}

function start_icecast() {
    logger::log "info" "starting icecast"
    /usr/bin/icecast2 -c /tmp/config.xml&
    NAMESPACED icecast_pid=$!
    logger::log "info" "icecast pid ${NAMESPACED icecast_pid}"
}

function start_watchdog() {
    while true
    do
        kill -0 ${NAMESPACED icecast_pid}
        if [[ $? != 0 ]]; then
            logger::log "error" "icecast is dead, restarting icecast and ezstream"
            start_icecast
            kill -9 $ezstream_pid #because if icecast is dead, then ezstream is dead fo shizzle.
            start_ezstream
        fi

        kill -0 ${NAMESPACED ezstream_pid}
        if [[ $? != 0 ]]; then
            logger:log "error" "ezstream is dead, restarting ezstream"
            start_ezstream
        fi
        sleep 0.25
    done
}